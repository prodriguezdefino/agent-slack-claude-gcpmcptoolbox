<configuration>
    <springProperty scope="context" name="APP_NAME" source="spring.application.name" defaultValue="gcp-cloud-function-slack-claude"/>

    <appender name="CONSOLE_JSON" class="ch.qos.logback.core.ConsoleAppender">
        <encoder class="net.logstash.logback.encoder.LogstashEncoder">
            <includeContext>true</includeContext>
            <includeCallerData>false</includeCallerData> <!-- Set to true for method/line number, impacts performance -->
            <customFields>{"application_name":"${APP_NAME}"}</customFields>
            <fieldNames>
                <!-- Remap field names to match Google Cloud Logging expectations -->
                <timestamp>timestamp</timestamp>
                <version>[ignore]</version> <!-- Spring Boot version, not needed for GCP -->
                <level>severity</level>
                <levelValue>[ignore]</levelValue> <!-- Numeric level, severity string is preferred -->
                <thread>thread</thread>
                <logger>logger</logger>
                <message>message</message>
                <stackTrace>stack_trace</stackTrace>
            </fieldNames>
            <stackTrace>
                <fieldName>stack_trace</fieldName>
                <throwableConverter class="net.logstash.logback.stacktrace.ShortenedThrowableConverter">
                    <maxDepthPerThrowable>30</maxDepthPerThrowable>
                    <maxLength>2048</maxLength>
                    <shortenedClassNameLength>20</shortenedClassNameLength>
                    <rootCauseFirst>true</rootCauseFirst>
                </throwableConverter>
            </stackTrace>
            <provider class="net.logstash.logback.composite.loggingevent.LoggingEventJsonProviders">
                <providers>
                    <timestamp>
                        <fieldName>timestamp</fieldName>
                        <timeZone>UTC</timeZone>
                    </timestamp>
                    <message/>
                    <loggerName>
                         <fieldName>logger</fieldName>
                    </loggerName>
                    <threadName>
                        <fieldName>thread</fieldName>
                    </threadName>
                    <logLevel>
                        <fieldName>severity</fieldName>
                    </logLevel>
                    <callerData>
                        <classFieldName>caller_class_name</classFieldName>
                        <methodFieldName>caller_method_name</methodFieldName>
                        <lineFieldName>caller_line_number</lineFieldName>
                        <fileFieldName>caller_file_name</fileFieldName>
                    </callerData>
                    <stackTrace>
                        <fieldName>stack_trace</fieldName>
                        <throwableConverter class="net.logstash.logback.stacktrace.ShortenedThrowableConverter">
                            <maxDepthPerThrowable>100</maxDepthPerThrowable>
                            <maxLength>16384</maxLength> <!-- Default is 2048, increase if needed -->
                            <shortenedClassNameLength>30</shortenedClassNameLength>
                            <exclude>^sun\.reflect\..*\.invoke</exclude>
                            <exclude>^net\.sf\.cglib\.proxy\.MethodProxy\.invoke</exclude>
                            <rootCauseFirst>true</rootCauseFirst>
                        </throwableConverter>
                    </stackTrace>
                    <mdc/> <!-- MDC properties will be included at the root level -->
                    <tags/>
                    <logstashMarkers/>
                    <arguments/>
                    <context/>
                    <customFields/>
                </providers>
            </provider>
        </encoder>
    </appender>

    <!-- Spring Profile for GCP: Use JSON logging -->
    <springProfile name="gcp,default">
        <root level="INFO">
            <appender-ref ref="CONSOLE_JSON"/>
        </root>
        <logger name="com.example.gcpcloudfunction" level="DEBUG" additivity="false">
             <appender-ref ref="CONSOLE_JSON"/>
        </logger>
        <logger name="com.slack.api" level="INFO" additivity="false">
            <appender-ref ref="CONSOLE_JSON"/>
        </logger>
         <logger name="org.springframework.web" level="INFO" additivity="false">
            <appender-ref ref="CONSOLE_JSON"/>
        </logger>
    </springProfile>

    <!-- Spring Profile for local development: Use standard console logging -->
    <springProfile name="local">
        <include resource="org/springframework/boot/logging/logback/base.xml"/>
        <root level="INFO">
            <appender-ref ref="CONSOLE"/>
        </root>
        <logger name="com.example.gcpcloudfunction" level="DEBUG" additivity="false">
            <appender-ref ref="CONSOLE"/>
        </logger>
        <logger name="com.slack.api" level="DEBUG" additivity="false">
            <appender-ref ref="CONSOLE"/>
        </logger>
    </springProfile>

</configuration>
